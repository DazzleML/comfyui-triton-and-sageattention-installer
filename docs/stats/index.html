<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI Triton &amp; SageAttention Installer - Install Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"
            onerror="document.getElementById('chart-fallback').classList.remove('hidden')"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #1c2128;
            --border: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #bc8cff;
            --accent-red: #f85149;
            --accent-orange: #d29922;
            --accent-pink: #f778ba;
        }

        *, *::before, *::after { box-sizing: border-box; }

        html, body {
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans",
                         Helvetica, Arial, sans-serif;
            line-height: 1.5;
        }

        a { color: var(--accent-blue); text-decoration: none; }
        a:hover { text-decoration: underline; }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        /* Header */
        header { text-align: center; margin-bottom: 2rem; }
        .banner-link {
            display: block;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.9rem 2rem;
            margin-bottom: 1.25rem;
            text-decoration: none;
            transition: border-color 0.2s;
        }
        .banner-link:hover {
            border-color: var(--accent-blue);
            text-decoration: none;
        }
        .banner-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.01em;
        }
        .banner-arrow {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            transition: color 0.2s;
        }
        .banner-link:hover .banner-arrow { color: var(--accent-blue); }
        header h1 {
            margin: 0 0 0.25rem 0;
            font-size: 1.75rem;
            font-weight: 600;
        }
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin: 0;
        }

        /* Tab Bar */
        .tab-bar {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        .tab {
            padding: 0.6rem 1.25rem;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: color 0.15s, border-color 0.15s;
            user-select: none;
        }
        .tab:hover {
            color: var(--text-primary);
        }
        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            text-align: center;
        }
        .card-primary { border-color: var(--accent-blue); }
        .card-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .card-pct {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        .card-sub {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Chart */
        .chart-section { margin: 2rem 0; }
        .chart-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .chart-note {
            font-weight: 400;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .chart-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .chart-btn {
            padding: 0.4rem 0.85rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: border-color 0.15s, color 0.15s;
        }
        .chart-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        .chart-btn.active {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(88, 166, 255, 0.08);
        }
        .chart-container {
            position: relative;
            height: 350px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }
        .note {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            font-style: italic;
        }

        /* Activity Indicators */
        .activity-section { margin: 2rem 0; }
        .activity-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .indicators {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        .indicator {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
        }
        .dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
        .dot.active { background: var(--accent-green); }
        .dot.inactive { background: var(--border); }

        /* Referrers Table */
        .referrers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .referrers-table th,
        .referrers-table td {
            padding: 0.6rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .referrers-table th {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        .referrers-table td {
            font-size: 0.9rem;
        }
        .referrers-table tr:last-child td {
            border-bottom: none;
        }
        .referrers-table .rank {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        .referrer-bar {
            height: 4px;
            background: var(--accent-blue);
            border-radius: 2px;
            margin-top: 0.25rem;
            transition: width 0.3s;
        }

        /* Community stats */
        .stat-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }
        .stat-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* Overview toggle checkboxes */
        .toggle-row {
            display: flex;
            gap: 1.25rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }
        .toggle-label input[type="checkbox"] {
            accent-color: var(--accent-blue);
        }
        .toggle-swatch {
            display: inline-block;
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }

        /* Loading */
        .loading { text-align: center; padding: 4rem 0; }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { color: var(--text-secondary); }

        /* Error */
        .error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin: 1rem 0;
        }
        .error button {
            margin-left: 1rem;
            padding: 0.3rem 0.75rem;
            border: 1px solid var(--accent-red);
            border-radius: 6px;
            background: transparent;
            color: var(--accent-red);
            cursor: pointer;
            font-size: 0.85rem;
        }
        .error button:hover { background: rgba(248, 81, 73, 0.15); }

        /* Privacy Note */
        .privacy-note {
            margin-top: 3rem;
            padding: 1rem 1.25rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        .privacy-note strong {
            color: var(--text-primary);
        }

        /* Footer */
        footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        footer p { margin: 0.3rem 0; }

        .hidden { display: none !important; }

        @media (max-width: 600px) {
            .summary-cards { grid-template-columns: repeat(2, 1fr); }
            .chart-container { height: 250px; }
            .container { padding: 1.25rem 1rem; }
            .indicators { gap: 1rem; }
            .banner-link { padding: 0.7rem 1rem; }
            .banner-title { font-size: 1.15rem; }
            .tab { padding: 0.5rem 0.85rem; font-size: 0.8rem; }
            .stat-item { min-width: 80px; padding: 0.75rem 1rem; }
            .stat-value { font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="https://github.com/DazzleML/comfyui-triton-and-sageattention-installer" class="banner-link">
                <p class="banner-title">ComfyUI Triton &amp; SageAttention Installer</p>
                <p class="banner-arrow">View repository &rarr;</p>
            </a>
            <h1>Install Statistics</h1>
            <p class="subtitle">Download, clone, and traffic tracking</p>
        </header>

        <div id="error-banner" class="error hidden">
            <span>Unable to load statistics. The data source may be temporarily unavailable.</span>
            <button onclick="loadDashboard()">Retry</button>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading statistics...</p>
        </div>

        <main id="content" class="hidden">
            <!-- Tab Bar -->
            <nav class="tab-bar">
                <div class="tab active" data-tab="installs" onclick="switchTab('installs')">Installs</div>
                <div class="tab" data-tab="views" onclick="switchTab('views')">Views</div>
                <div class="tab" data-tab="community" onclick="switchTab('community')">Community</div>
                <div class="tab" data-tab="overview" onclick="switchTab('overview')">Overview</div>
            </nav>

            <!-- ==================== INSTALLS TAB ==================== -->
            <div id="tab-installs" class="tab-content active">
                <section class="summary-cards">
                    <div class="card card-primary">
                        <div class="card-label">Total Installs</div>
                        <div class="card-value" id="total-installs">--</div>
                        <div class="card-sub">downloads + clones</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Downloads</div>
                        <div class="card-value" id="total-downloads">--</div>
                        <div class="card-pct" id="downloads-pct">--%</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Clones</div>
                        <div class="card-value" id="total-clones">--</div>
                        <div class="card-pct" id="clones-pct">--%</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Recent Activity</div>
                        <div class="card-value" id="recent-value">--</div>
                        <div class="card-sub" id="recent-window">--</div>
                    </div>
                </section>

                <section class="chart-section">
                    <h2>Daily Activity <span class="chart-note" id="installs-chart-note">(rolling 31-day window)</span></h2>
                    <div class="chart-controls">
                        <button class="chart-btn active" id="btn-installs-recent" onclick="showInstallsRecent()">Last 31 Days</button>
                        <button class="chart-btn" id="btn-installs-all" onclick="showInstallsAll()">All History</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="installsChart"></canvas>
                    </div>
                    <p id="chart-fallback" class="note hidden">
                        Chart library could not be loaded. Summary statistics are shown above.
                    </p>
                    <p id="sparse-data-note" class="note hidden">
                        Tracking started recently. More data points will appear as daily stats accumulate.
                    </p>
                    <p id="installs-archive-loading" class="note hidden">Loading historical data...</p>
                    <p id="installs-archive-note" class="note hidden"></p>
                </section>

                <section class="activity-section">
                    <h2>Activity Windows</h2>
                    <div class="indicators">
                        <div class="indicator">
                            <span class="dot inactive" id="dot-24h"></span>
                            <span>Last 24h: <strong id="val-24h">0</strong></span>
                        </div>
                        <div class="indicator">
                            <span class="dot inactive" id="dot-7d"></span>
                            <span>Last 7 days: <strong id="val-7d">0</strong></span>
                        </div>
                        <div class="indicator">
                            <span class="dot inactive" id="dot-30d"></span>
                            <span>Last 30 days: <strong id="val-30d">0</strong></span>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ==================== VIEWS TAB ==================== -->
            <div id="tab-views" class="tab-content">
                <section class="summary-cards">
                    <div class="card card-primary">
                        <div class="card-label">Total Views</div>
                        <div class="card-value" id="total-views">--</div>
                        <div class="card-sub">page views (accumulated)</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Today's Views</div>
                        <div class="card-value" id="today-views">--</div>
                        <div class="card-sub">latest data point</div>
                    </div>
                    <div class="card">
                        <div class="card-label">7-Day Views</div>
                        <div class="card-value" id="week-views">--</div>
                        <div class="card-sub">rolling week</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Top Referrer</div>
                        <div class="card-value" id="top-referrer" style="font-size: 1.4rem;">--</div>
                        <div class="card-sub" id="top-referrer-count">--</div>
                    </div>
                </section>

                <section class="chart-section">
                    <h2>Daily Page Views <span class="chart-note" id="views-chart-note">(rolling window)</span></h2>
                    <div class="chart-container">
                        <canvas id="viewsChart"></canvas>
                    </div>
                </section>

                <section class="activity-section">
                    <h2>Top Referrers <span class="chart-note">(14-day snapshot)</span></h2>
                    <table class="referrers-table" id="referrers-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Source</th>
                                <th>Views</th>
                                <th>Unique</th>
                            </tr>
                        </thead>
                        <tbody id="referrers-body">
                            <tr><td colspan="4" style="color: var(--text-secondary); text-align: center;">No referrer data available</td></tr>
                        </tbody>
                    </table>
                </section>
            </div>

            <!-- ==================== COMMUNITY TAB ==================== -->
            <div id="tab-community" class="tab-content">
                <div class="stat-row">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-stars">--</div>
                        <div class="stat-label">Stars</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-forks">--</div>
                        <div class="stat-label">Forks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-issues">--</div>
                        <div class="stat-label">Open Issues</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-age">--</div>
                        <div class="stat-label">Project Age</div>
                    </div>
                </div>

                <section class="chart-section">
                    <h2>Star History</h2>
                    <div class="chart-container">
                        <canvas id="starsChart"></canvas>
                    </div>
                    <p id="stars-loading" class="note">Loading star history from GitHub API...</p>
                    <p id="stars-note" class="note hidden"></p>
                </section>

                <section class="chart-section">
                    <h2>Community Trends <span class="chart-note">(daily snapshots)</span></h2>
                    <div class="chart-container">
                        <canvas id="communityTrendsChart"></canvas>
                    </div>
                    <p id="community-trends-note" class="note hidden"></p>
                </section>
            </div>

            <!-- ==================== OVERVIEW TAB ==================== -->
            <div id="tab-overview" class="tab-content">
                <section class="summary-cards">
                    <div class="card card-primary">
                        <div class="card-label">Total Installs</div>
                        <div class="card-value" id="ov-installs">--</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Total Views</div>
                        <div class="card-value" id="ov-views">--</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Stars</div>
                        <div class="card-value" id="ov-stars">--</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Forks</div>
                        <div class="card-value" id="ov-forks">--</div>
                    </div>
                </section>

                <section class="chart-section">
                    <h2>Combined Daily Activity <span class="chart-note">(all metrics)</span></h2>
                    <div class="toggle-row">
                        <label class="toggle-label">
                            <input type="checkbox" id="ov-toggle-views" checked onchange="renderOverviewChart()">
                            <span class="toggle-swatch" style="background: var(--accent-blue);"></span>
                            Views
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="ov-toggle-clones" checked onchange="renderOverviewChart()">
                            <span class="toggle-swatch" style="background: var(--accent-purple);"></span>
                            Clones
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="ov-toggle-downloads" checked onchange="renderOverviewChart()">
                            <span class="toggle-swatch" style="background: var(--accent-green);"></span>
                            Downloads
                        </label>
                        <label class="toggle-label">
                            <input type="checkbox" id="ov-toggle-installs" checked onchange="renderOverviewChart()">
                            <span class="toggle-swatch" style="background: rgba(88, 166, 255, 0.25);"></span>
                            Total Installs (area)
                        </label>
                    </div>
                    <div class="chart-container">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </section>
            </div>
        </main>

        <footer>
            <p>Data updates daily at 3:00 AM UTC &middot; Last data point: <span id="last-updated">--</span></p>
            <p>
                <a href="https://github.com/DazzleML/comfyui-triton-and-sageattention-installer">Repository</a> &middot;
                <a href="https://github.com/DazzleML/comfyui-triton-and-sageattention-installer/releases">Releases</a>
            </p>
            <aside class="privacy-note">
                <strong>Privacy</strong> &mdash; This tool contains no telemetry or tracking of any kind.
                All statistics shown here come from
                <a href="https://docs.github.com/en/rest/metrics/traffic">GitHub&rsquo;s built-in traffic API</a>,
                which provides aggregate, anonymous counts of repository page views, git clones, and release
                downloads. &ldquo;Installs&rdquo; refers to git clones plus release downloads as reported by GitHub.
                No data is collected from your machine before, during, or after installation.
                <a href="https://stackoverflow.com/questions/4338358/github-can-i-see-the-number-of-downloads-for-a-repo">Learn more</a>.
            </aside>
        </footer>
    </div>

    <script>
        // Configuration
        const GIST_RAW_BASE = 'https://gist.githubusercontent.com/djdarcy/77f23ace7465637447db0a6c79cf46ba/raw';
        const STATE_URL = GIST_RAW_BASE + '/state.json';
        const ARCHIVE_GIST_ID = 'b44b12adb623ae3ac8f1993970ab5266';
        const ARCHIVE_API_URL = 'https://api.github.com/gists/' + ARCHIVE_GIST_ID;
        const REPO_OWNER = 'DazzleML';
        const REPO_NAME = 'comfyui-triton-and-sageattention-installer';
        const REPO_CREATED = '2025-07-23'; // for project age calculation

        // State
        let currentState = null;
        let charts = {};          // keyed by canvas id
        let archiveData = null;   // cached after first fetch
        let starHistory = null;   // cached star timestamps

        // ==================== UTILITIES ====================

        function fmt(n) {
            return (n || 0).toLocaleString('en-US');
        }

        function formatDate(dateStr) {
            var dt = new Date(dateStr);
            return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
        }

        function formatDateFull(dateStr) {
            var dt = new Date(dateStr);
            return dt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' });
        }

        function show(id) { document.getElementById(id).classList.remove('hidden'); }
        function hide(id) { document.getElementById(id).classList.add('hidden'); }
        function setText(id, text) { document.getElementById(id).textContent = text; }

        function sumWindow(history, n, field) {
            var w = history.slice(-n);
            return w.reduce(function(sum, d) { return sum + (d[field || 'total'] || 0); }, 0);
        }

        // Detect trailing zeros and replace with last real value for projection.
        // Returns { data: [...], projectedFrom: index } where projectedFrom is
        // the first projected index. If no projection, projectedFrom === data.length.
        function projectTrailingZeros(values) {
            var lastRealIdx = values.length - 1;
            while (lastRealIdx >= 0 && values[lastRealIdx] === 0) {
                lastRealIdx--;
            }
            if (lastRealIdx < 0 || lastRealIdx === values.length - 1) {
                return { data: values, projectedFrom: values.length };
            }
            var result = values.slice();
            var lastVal = result[lastRealIdx];
            for (var i = lastRealIdx + 1; i < result.length; i++) {
                result[i] = lastVal;
            }
            return { data: result, projectedFrom: lastRealIdx + 1 };
        }

        // Build Chart.js segment config for dashed projection from a given index.
        // The dashed segment starts from the last real point to the first projected point.
        function projectionSegmentConfig(projectedFrom, dataLength) {
            if (projectedFrom >= dataLength) return {};
            return {
                borderDash: function(ctx) {
                    return ctx.p0DataIndex >= projectedFrom - 1 ? [6, 3] : undefined;
                }
            };
        }

        function destroyChart(canvasId) {
            if (charts[canvasId]) {
                charts[canvasId].destroy();
                charts[canvasId] = null;
            }
        }

        function setDot(id, active) {
            var dot = document.getElementById(id);
            dot.className = active ? 'dot active' : 'dot inactive';
        }

        // ==================== TAB SWITCHING ====================

        function switchTab(tabName) {
            // Update tab bar
            document.querySelectorAll('.tab').forEach(function(t) {
                t.classList.toggle('active', t.dataset.tab === tabName);
            });
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(function(tc) {
                tc.classList.toggle('active', tc.id === 'tab-' + tabName);
            });
            // Update URL hash
            history.replaceState(null, '', '#' + tabName);

            // Lazy-render charts when switching to a tab
            if (tabName === 'views' && currentState) renderViewsTab();
            if (tabName === 'community' && currentState) renderCommunityTab();
            if (tabName === 'overview' && currentState) renderOverviewChart();
        }

        // ==================== MAIN ENTRY POINT ====================

        async function loadDashboard() {
            hide('error-banner');
            hide('content');
            show('loading');

            try {
                var response = await fetch(STATE_URL + '?t=' + Date.now());
                if (!response.ok) throw new Error('HTTP ' + response.status);
                currentState = await response.json();

                // Deduplicate dailyHistory by UTC date (keep last entry per day)
                if (currentState.dailyHistory) {
                    var seen = {};
                    var deduped = [];
                    for (var i = 0; i < currentState.dailyHistory.length; i++) {
                        var d = currentState.dailyHistory[i];
                        var key = d.date.slice(0, 10); // YYYY-MM-DD
                        if (seen[key] !== undefined) {
                            deduped[seen[key]] = d; // replace with later entry
                        } else {
                            seen[key] = deduped.length;
                            deduped.push(d);
                        }
                    }
                    currentState.dailyHistory = deduped;
                }

                renderInstallsTab(currentState);

                hide('loading');
                show('content');

                // Check URL hash for initial tab
                var hash = window.location.hash.replace('#', '');
                if (['views', 'community', 'overview'].indexOf(hash) !== -1) {
                    switchTab(hash);
                }
            } catch (err) {
                hide('loading');
                show('error-banner');
                console.error('Failed to load stats:', err);
            }
        }

        // ==================== INSTALLS TAB ====================

        function renderInstallsTab(state) {
            var totalDl = state.totalDownloads || 0;
            var totalCl = state.totalClones || 0;
            var combined = totalDl + totalCl;

            setText('total-installs', fmt(combined));
            setText('total-downloads', fmt(totalDl));
            setText('total-clones', fmt(totalCl));

            var dlPct = combined > 0 ? ((totalDl / combined) * 100).toFixed(1) : '0';
            var clPct = combined > 0 ? ((totalCl / combined) * 100).toFixed(1) : '0';
            setText('downloads-pct', dlPct + '% of total');
            setText('clones-pct', clPct + '% of total');

            // Recent activity (cascading)
            var history = state.dailyHistory || [];
            var last24h = history.length > 0 ? (history[history.length - 1].total || 0) : 0;
            var lastWeek = sumWindow(history, 7);
            var lastMonth = sumWindow(history, 31);

            if (last24h > 0) {
                setText('recent-value', '+' + fmt(last24h));
                setText('recent-window', 'in the last 24 hours');
            } else if (lastWeek > 0) {
                setText('recent-value', '+' + fmt(lastWeek));
                setText('recent-window', 'in the last 7 days');
            } else if (lastMonth > 0) {
                setText('recent-value', '+' + fmt(lastMonth));
                setText('recent-window', 'in the last 30 days');
            } else {
                setText('recent-value', '0');
                setText('recent-window', 'no recent activity');
            }

            // Chart
            renderInstallsChart(history);

            // Activity dots
            setText('val-24h', fmt(last24h));
            setText('val-7d', fmt(lastWeek));
            setText('val-30d', fmt(lastMonth));
            setDot('dot-24h', last24h > 0);
            setDot('dot-7d', lastWeek > 0);
            setDot('dot-30d', lastMonth > 0);

            // Footer last updated
            if (history.length > 0) {
                setText('last-updated', formatDateFull(history[history.length - 1].date));
            }
        }

        function renderInstallsChart(history) {
            if (typeof Chart === 'undefined') return;

            if (history.length === 0) {
                show('sparse-data-note');
                setText('sparse-data-note', 'No data points available yet. The tracking workflow runs daily at 3:00 AM UTC.');
                return;
            }

            if (history.length <= 2) {
                show('sparse-data-note');
            }

            var labels = history.map(function(d) { return formatDate(d.date); });
            var totals = history.map(function(d) { return d.total || 0; });
            var clones = history.map(function(d) { return d.clones || 0; });
            var downloads = history.map(function(d) { return d.downloads || 0; });

            // Check if any line matches the total exactly at every point
            // If so, render total as area-only (no top line) so the matching line stays visible
            var clonesMatchTotal = totals.every(function(t, i) { return t === clones[i]; });
            var downloadsMatchTotal = totals.every(function(t, i) { return t === downloads[i]; });
            var totalBorderWidth = (clonesMatchTotal || downloadsMatchTotal) ? 0 : 2;

            var pointSize = history.length === 1 ? 6 : 3;
            var smallPoint = history.length === 1 ? 6 : 2;

            destroyChart('installsChart');
            var ctx = document.getElementById('installsChart').getContext('2d');

            charts['installsChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total',
                            data: totals,
                            borderColor: totalBorderWidth > 0 ? '#58a6ff' : 'transparent',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: totalBorderWidth > 0 ? pointSize : 0,
                            pointHoverRadius: totalBorderWidth > 0 ? pointSize + 2 : 0,
                            borderWidth: totalBorderWidth,
                            order: 2  // render behind lines
                        },
                        {
                            label: 'Clones',
                            data: clones,
                            borderColor: '#bc8cff',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.3,
                            pointRadius: smallPoint,
                            pointHoverRadius: smallPoint + 2,
                            borderWidth: 2,
                            order: 1  // render on top
                        },
                        {
                            label: 'Downloads',
                            data: downloads,
                            borderColor: '#3fb950',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.3,
                            pointRadius: smallPoint,
                            pointHoverRadius: smallPoint + 2,
                            borderWidth: 2,
                            order: 1
                        }
                    ]
                },
                options: buildChartOptions()
            });
        }

        function showInstallsRecent() {
            if (!currentState) return;
            document.getElementById('btn-installs-recent').classList.add('active');
            document.getElementById('btn-installs-all').classList.remove('active');
            setText('installs-chart-note', '(rolling 31-day window)');
            hide('installs-archive-note');
            hide('installs-archive-loading');
            renderInstallsChart(currentState.dailyHistory || []);
        }

        async function showInstallsAll() {
            if (!currentState) return;
            document.getElementById('btn-installs-all').classList.add('active');
            document.getElementById('btn-installs-recent').classList.remove('active');

            if (archiveData) {
                renderFullInstallsHistory();
                return;
            }

            show('installs-archive-loading');
            hide('installs-archive-note');

            try {
                var response = await fetch(ARCHIVE_API_URL);
                if (!response.ok) {
                    if (response.status === 404) throw new Error('Archive gist not found');
                    if (response.status === 403) throw new Error('GitHub API rate limit reached. Try again later.');
                    throw new Error('HTTP ' + response.status);
                }

                var gist = await response.json();
                var archiveFiles = [];

                for (var filename in gist.files) {
                    if (filename.match(/^archive-\d{4}-\d{2}\.json$/)) {
                        archiveFiles.push(gist.files[filename]);
                    }
                }

                if (archiveFiles.length === 0) {
                    hide('installs-archive-loading');
                    show('installs-archive-note');
                    setText('installs-archive-note', 'No archived monthly data yet. Monthly archives begin on the 1st of each month. Showing current rolling window.');
                    setText('installs-chart-note', '(all available data)');
                    renderInstallsChart(currentState.dailyHistory || []);
                    return;
                }

                var allHistory = [];
                for (var i = 0; i < archiveFiles.length; i++) {
                    try {
                        var rawUrl = archiveFiles[i].raw_url;
                        var archiveResp = await fetch(rawUrl);
                        if (archiveResp.ok) {
                            var archiveContent = await archiveResp.json();
                            if (archiveContent.dailyHistory && archiveContent.dailyHistory.length > 0) {
                                allHistory = allHistory.concat(archiveContent.dailyHistory);
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to load archive file:', archiveFiles[i].filename, e);
                    }
                }

                var currentHistory = currentState.dailyHistory || [];
                allHistory = allHistory.concat(currentHistory);

                // Deduplicate by date
                var seen = {};
                var deduplicated = [];
                for (var j = 0; j < allHistory.length; j++) {
                    var dateKey = allHistory[j].date.slice(0, 10);
                    if (!seen[dateKey]) {
                        seen[dateKey] = true;
                        deduplicated.push(allHistory[j]);
                    }
                }

                deduplicated.sort(function(a, b) {
                    return new Date(a.date) - new Date(b.date);
                });

                archiveData = deduplicated;
                renderFullInstallsHistory();

            } catch (err) {
                hide('installs-archive-loading');
                show('installs-archive-note');
                setText('installs-archive-note', 'Could not load historical data: ' + err.message + '. Showing current rolling window.');
                renderInstallsChart(currentState.dailyHistory || []);
            }
        }

        function renderFullInstallsHistory() {
            hide('installs-archive-loading');
            var data = archiveData || (currentState ? currentState.dailyHistory : []) || [];
            var months = data.length > 0
                ? Math.ceil((new Date(data[data.length - 1].date) - new Date(data[0].date)) / (1000 * 60 * 60 * 24 * 30))
                : 0;
            var label = data.length + ' data points';
            if (months > 1) label += ' over ~' + months + ' months';
            setText('installs-chart-note', '(' + label + ')');

            if (archiveData && archiveData.length > (currentState.dailyHistory || []).length) {
                show('installs-archive-note');
                setText('installs-archive-note', 'Showing all available historical data including monthly archives.');
            } else {
                show('installs-archive-note');
                setText('installs-archive-note', 'No additional archived data found beyond the current rolling window.');
            }

            renderInstallsChart(data);
        }

        // ==================== VIEWS TAB ====================

        var viewsRendered = false;

        function renderViewsTab() {
            if (viewsRendered) return;
            viewsRendered = true;

            var state = currentState;
            var totalViews = state.totalViews || 0;
            var history = state.dailyHistory || [];
            var referrers = state.referrers || [];

            setText('total-views', fmt(totalViews));

            // Find latest day with real view data (skip trailing zeros = no data yet)
            var todayViews = 0;
            var todayLabel = 'latest data point';
            for (var i = history.length - 1; i >= 0; i--) {
                if ((history[i].views || 0) > 0) {
                    todayViews = history[i].views;
                    if (i < history.length - 1) {
                        todayLabel = formatDate(history[i].date);
                    }
                    break;
                }
            }
            setText('today-views', fmt(todayViews));
            document.getElementById('today-views').parentElement.querySelector('.card-sub').textContent = todayLabel;

            var weekViews = sumWindow(history, 7, 'views');
            setText('week-views', fmt(weekViews));

            if (referrers.length > 0) {
                setText('top-referrer', referrers[0].source);
                setText('top-referrer-count', fmt(referrers[0].count) + ' views (' + fmt(referrers[0].uniques) + ' unique)');
            } else {
                setText('top-referrer', 'N/A');
                setText('top-referrer-count', 'no data yet');
            }

            // Views chart
            renderViewsChart(history);

            // Referrers table
            renderReferrersTable(referrers);
        }

        function renderViewsChart(history) {
            if (typeof Chart === 'undefined') return;
            if (history.length === 0) return;

            var labels = history.map(function(d) { return formatDate(d.date); });
            var viewsRaw = history.map(function(d) { return d.views || 0; });
            var proj = projectTrailingZeros(viewsRaw);
            var hasProjection = proj.projectedFrom < proj.data.length;

            setText('views-chart-note', '(' + history.length + ' days)');

            destroyChart('viewsChart');
            var ctx = document.getElementById('viewsChart').getContext('2d');

            var dataset = {
                label: 'Page Views',
                data: proj.data,
                borderColor: '#58a6ff',
                backgroundColor: 'rgba(88, 166, 255, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: function(ctx) {
                    return hasProjection && ctx.dataIndex >= proj.projectedFrom ? 4 : 3;
                },
                pointStyle: function(ctx) {
                    return hasProjection && ctx.dataIndex >= proj.projectedFrom ? 'rectRot' : 'circle';
                },
                pointHoverRadius: 5,
                borderWidth: 2
            };

            if (hasProjection) {
                dataset.segment = projectionSegmentConfig(proj.projectedFrom, proj.data.length);
            }

            charts['viewsChart'] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [dataset] },
                options: buildChartOptions()
            });
        }

        function renderReferrersTable(referrers) {
            var tbody = document.getElementById('referrers-body');
            if (referrers.length === 0) return;

            var maxCount = referrers[0].count || 1;
            var html = '';

            for (var i = 0; i < referrers.length; i++) {
                var r = referrers[i];
                var barWidth = Math.max(4, (r.count / maxCount) * 100);
                html += '<tr>';
                html += '<td class="rank">' + (i + 1) + '</td>';
                html += '<td>' + escapeHtml(r.source) + '<div class="referrer-bar" style="width:' + barWidth + '%"></div></td>';
                html += '<td>' + fmt(r.count) + '</td>';
                html += '<td>' + fmt(r.uniques) + '</td>';
                html += '</tr>';
            }

            tbody.innerHTML = html;
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== COMMUNITY TAB ====================

        var communityRendered = false;

        function renderCommunityTab() {
            if (communityRendered) return;
            communityRendered = true;

            var state = currentState;

            setText('stat-stars', fmt(state.stars || 0));
            setText('stat-forks', fmt(state.forks || 0));
            setText('stat-issues', fmt(state.openIssues || 0));

            // Project age
            var created = new Date(REPO_CREATED);
            var now = new Date();
            var months = Math.floor((now - created) / (1000 * 60 * 60 * 24 * 30));
            if (months >= 12) {
                var years = Math.floor(months / 12);
                var rem = months % 12;
                setText('stat-age', years + 'y ' + rem + 'mo');
            } else {
                setText('stat-age', months + ' mo');
            }

            // Fetch star history (client-side, unauthenticated)
            fetchStarHistory();

            // Render community trends from dailyHistory (stars, forks, issues over time)
            renderCommunityTrends(state.dailyHistory || []);
        }

        async function fetchStarHistory() {
            // Check sessionStorage cache
            var cached = sessionStorage.getItem('starHistory');
            if (cached) {
                try {
                    starHistory = JSON.parse(cached);
                    renderStarChart();
                    return;
                } catch (e) { /* ignore bad cache */ }
            }

            try {
                var stars = [];
                var page = 1;
                var perPage = 100;
                var done = false;

                while (!done) {
                    var url = 'https://api.github.com/repos/' + REPO_OWNER + '/' + REPO_NAME + '/stargazers?per_page=' + perPage + '&page=' + page;
                    var resp = await fetch(url, {
                        headers: { 'Accept': 'application/vnd.github.star+json' }
                    });

                    if (resp.status === 403) {
                        throw new Error('GitHub API rate limit reached');
                    }
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);

                    var data = await resp.json();
                    if (data.length === 0) { done = true; break; }

                    for (var i = 0; i < data.length; i++) {
                        stars.push(data[i].starred_at);
                    }

                    if (data.length < perPage) { done = true; }
                    page++;

                    // Safety: max 10 pages (1000 stars)
                    if (page > 10) break;
                }

                // Sort chronologically
                stars.sort();
                starHistory = stars;

                // Cache in sessionStorage
                sessionStorage.setItem('starHistory', JSON.stringify(stars));

                renderStarChart();

            } catch (err) {
                hide('stars-loading');
                show('stars-note');
                setText('stars-note', 'Could not load star history: ' + err.message);
                console.error('Star history fetch failed:', err);
            }
        }

        function renderStarChart() {
            hide('stars-loading');

            if (!starHistory || starHistory.length === 0) {
                show('stars-note');
                setText('stars-note', 'No star data available.');
                return;
            }

            if (typeof Chart === 'undefined') return;

            // Build cumulative star count by date
            var dailyStars = {};
            for (var i = 0; i < starHistory.length; i++) {
                var dateKey = starHistory[i].slice(0, 10);
                dailyStars[dateKey] = (dailyStars[dateKey] || 0) + 1;
            }

            var dates = Object.keys(dailyStars).sort();
            var labels = dates.map(function(d) { return formatDate(d); });
            var cumulative = [];
            var running = 0;
            for (var j = 0; j < dates.length; j++) {
                running += dailyStars[dates[j]];
                cumulative.push(running);
            }

            show('stars-note');
            setText('stars-note', starHistory.length + ' stars tracked from ' + formatDateFull(dates[0]) + ' to ' + formatDateFull(dates[dates.length - 1]));

            destroyChart('starsChart');
            var ctx = document.getElementById('starsChart').getContext('2d');

            charts['starsChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Stars',
                        data: cumulative,
                        borderColor: '#d29922',
                        backgroundColor: 'rgba(210, 153, 34, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: cumulative.length > 50 ? 0 : 3,
                        pointHoverRadius: 5,
                        borderWidth: 2
                    }]
                },
                options: buildChartOptions()
            });
        }

        function renderCommunityTrends(history) {
            if (typeof Chart === 'undefined') return;

            // Filter to entries that have community data (stars/forks/issues fields)
            var withData = history.filter(function(d) {
                return d.stars !== undefined || d.forks !== undefined || d.openIssues !== undefined;
            });

            if (withData.length < 2) {
                show('community-trends-note');
                setText('community-trends-note', 'Community trend data will appear after the workflow collects daily snapshots. Currently ' + withData.length + ' data point(s).');
                return;
            }

            var labels = withData.map(function(d) { return formatDate(d.date); });

            destroyChart('communityTrendsChart');
            var ctx = document.getElementById('communityTrendsChart').getContext('2d');

            charts['communityTrendsChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Stars',
                            data: withData.map(function(d) { return d.stars || 0; }),
                            borderColor: '#d29922',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Forks',
                            data: withData.map(function(d) { return d.forks || 0; }),
                            borderColor: '#bc8cff',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderWidth: 2,
                            yAxisID: 'y2'
                        },
                        {
                            label: 'Open Issues',
                            data: withData.map(function(d) { return d.openIssues || 0; }),
                            borderColor: '#3fb950',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            borderWidth: 2,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e', maxRotation: 45 },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: false,
                            title: { display: true, text: 'Stars', color: '#d29922' },
                            ticks: { color: '#8b949e', precision: 0 },
                            grid: { color: '#30363d' }
                        },
                        y2: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            title: { display: true, text: 'Forks / Issues', color: '#8b949e' },
                            ticks: { color: '#8b949e', precision: 0 },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e6edf3', usePointStyle: true, pointStyle: 'circle' }
                        },
                        tooltip: {
                            backgroundColor: '#161b22',
                            titleColor: '#e6edf3',
                            bodyColor: '#8b949e',
                            borderColor: '#30363d',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    return ' ' + context.dataset.label + ': ' + fmt(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== OVERVIEW TAB ====================

        var overviewRendered = false;

        function renderOverviewChart() {
            var state = currentState;
            if (!state) return;

            var history = state.dailyHistory || [];
            if (history.length === 0) return;
            if (typeof Chart === 'undefined') return;

            // Update summary cards
            var combined = (state.totalDownloads || 0) + (state.totalClones || 0);
            setText('ov-installs', fmt(combined));
            setText('ov-views', fmt(state.totalViews || 0));
            setText('ov-stars', fmt(state.stars || 0));
            setText('ov-forks', fmt(state.forks || 0));

            var labels = history.map(function(d) { return formatDate(d.date); });
            var datasets = [];

            var showViews = document.getElementById('ov-toggle-views').checked;
            var showClones = document.getElementById('ov-toggle-clones').checked;
            var showDownloads = document.getElementById('ov-toggle-downloads').checked;
            var showInstalls = document.getElementById('ov-toggle-installs').checked;

            if (showInstalls) {
                datasets.push({
                    label: 'Total Installs',
                    data: history.map(function(d) { return d.total || 0; }),
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(88, 166, 255, 0.12)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 0,
                    borderWidth: 0,
                    order: 3
                });
            }

            if (showViews) {
                var viewsRaw = history.map(function(d) { return d.views || 0; });
                var viewsProj = projectTrailingZeros(viewsRaw);
                var viewsDs = {
                    label: 'Views',
                    data: viewsProj.data,
                    borderColor: '#58a6ff',
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    borderWidth: 2,
                    order: 1
                };
                if (viewsProj.projectedFrom < viewsProj.data.length) {
                    viewsDs.segment = projectionSegmentConfig(viewsProj.projectedFrom, viewsProj.data.length);
                }
                datasets.push(viewsDs);
            }

            if (showClones) {
                datasets.push({
                    label: 'Clones',
                    data: history.map(function(d) { return d.clones || 0; }),
                    borderColor: '#bc8cff',
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    borderWidth: 2,
                    order: 1
                });
            }

            if (showDownloads) {
                datasets.push({
                    label: 'Downloads',
                    data: history.map(function(d) { return d.downloads || 0; }),
                    borderColor: '#3fb950',
                    backgroundColor: 'transparent',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    borderWidth: 2,
                    order: 1
                });
            }

            destroyChart('overviewChart');
            var ctx = document.getElementById('overviewChart').getContext('2d');

            charts['overviewChart'] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: buildChartOptions()
            });

            overviewRendered = true;
        }

        // ==================== SHARED CHART OPTIONS ====================

        function buildChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        ticks: { color: '#8b949e', maxRotation: 45 },
                        grid: { color: '#30363d' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#8b949e', precision: 0 },
                        grid: { color: '#30363d' }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#e6edf3',
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#161b22',
                        titleColor: '#e6edf3',
                        bodyColor: '#8b949e',
                        borderColor: '#30363d',
                        borderWidth: 1,
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                return ' ' + context.dataset.label + ': ' + fmt(context.parsed.y);
                            }
                        }
                    }
                }
            };
        }

        // ==================== BOOT ====================

        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
